import{d as e,r as o,o as n,b as a,k as t,l,m as r,A as s,t as i,u as c,q as u}from"./vendor-DG3C2HZs.js";import{_ as g}from"./index-CDvNi4Z9.js";const d={class:"google-login-container"},v={key:0,class:"error-message"},m=g(e({__name:"GoogleSignIn",props:{isRegister:{type:Boolean,default:!1}},setup(e){const g=e,m=o(!0),h=o(!1),p=c(),w=o(""),f=o(0);function y(){return w.value="Отсутствует VITE_GOOGLE_CLIENT_ID. Создайте .env файл в корне проекта.",!1}function G(){return new Promise(((e,o)=>{var n,a;if(null==(a=null==(n=window.google)?void 0:n.accounts)?void 0:a.id)return void e(window.google);const t=document.createElement("script");t.src="https://accounts.google.com/gsi/client",t.onload=()=>setTimeout((()=>e(window)),300),t.onerror=e=>o(e),t.async=!0,t.defer=!0,document.head.appendChild(t)}))}async function _(){if(f.value>=3)w.value="Превышено количество попыток. Обновите страницу.";else{f.value++,w.value=`Повторная попытка ${f.value}/3...`;try{await G();!y()&&f.value<3&&setTimeout((()=>_()),1500)}catch(e){console.error("Retry initialization failed:",e),w.value=`Попытка ${f.value}/3 не удалась`}}}async function b(){try{const e=new AbortController,o=setTimeout((()=>e.abort()),3e3),n=await fetch("undefined/health",{signal:e.signal});return clearTimeout(o),n.ok}catch{return!1}}function k(e){try{console.log("Обработка авторизации в демо-режиме");const o=function(e){try{const o=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/");return JSON.parse(window.atob(o))}catch(o){return console.error("Error parsing JWT:",o),null}}(e.credential);if(console.log("Данные из токена:",o),!o)return void(w.value="Не удалось прочитать данные авторизации");const n={id:"demo_"+Date.now(),name:o.name||"Демо Пользователь",email:o.email||"demo@example.com",phone:"",userType:g.isRegister?"worker":"employer",photo:o.picture||"",age:0,skills:[],experience:"",hasOtherJobs:!1,authProvider:"google",token:"demo_token_"+Date.now(),isDemoMode:!0};localStorage.setItem("user",JSON.stringify(n)),console.log("Демо-пользователь сохранен:",n),p.push("/")}catch(o){console.error("Ошибка демо-авторизации:",o),w.value="Ошибка при демо-авторизации"}}return n((async()=>{try{m.value=await b(),h.value=!0,setTimeout((()=>{h.value=!1}),3e3)}catch(e){m.value=!1,h.value=!0}})),n((async()=>{try{await G();y()||setTimeout((()=>_()),1e3)}catch(e){console.error("Failed to load Google Sign-In:",e),w.value="Не удалось загрузить Google Sign-In"}})),a((()=>{window.handleGoogleLogin&&delete window.handleGoogleLogin})),window.handleGoogleLogin=async function(e){try{if(console.log("Получен ответ от Google авторизации"),!e||!e.credential)return console.error("Некорректный ответ от Google Auth:",e),void(w.value="Ошибка авторизации через Google");try{await b()?(console.log("Сервер доступен, выполняем стандартную авторизацию"),await async function(){var e,o;try{const e={token:"fallback_token_"+Date.now(),authProvider:"google"};localStorage.setItem("user",JSON.stringify(e)),p.push("/")}catch(n){console.error("Google auth error:",n);const a=(null==(o=null==(e=n.response)?void 0:e.data)?void 0:o.error)||n.message||"Ошибка авторизации через Google";w.value=a,("NETWORK_ERROR"===n.code||n.message.includes("fetch"))&&(m.value=!1)}}()):(console.log("Сервер недоступен, переключаемся в демо режим"),k(e))}catch(o){console.error("Ошибка при проверке доступности сервера:",o),console.log("Ошибка соединения, переключаемся в демо режим"),k(e)}}catch(n){return console.error("Критическая ошибка в обработчике Google Auth:",n),w.value="Ошибка авторизации через Google",!1}},(e,o)=>(u(),t("div",d,[o[1]||(o[1]=l("div",{id:"google-signin-button",class:"google-signin-button"},null,-1)),w.value?(u(),t("div",v,[o[0]||(o[0]=l("i",{class:"fas fa-exclamation-circle"},null,-1)),s(" "+i(w.value)+" ",1),l("button",{onClick:_,class:"retry-btn"},"Попробовать снова")])):r("",!0)]))}}),[["__scopeId","data-v-8a676e5b"]]);export{m as G};
